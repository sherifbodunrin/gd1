<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boss Battle Game</title>
    <script src="https://cdn.jsdelivr.net/npm/konva@8.3.0/konva.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <script>
        const stage = new Konva.Stage({
            container: 'container',
            width: window.innerWidth,
            height: window.innerHeight
        });
        const layer = new Konva.Layer();
        stage.add(layer);

        // Load the player sprite image
        const playerImage = new Image();
        playerImage.src = 'https://preview.redd.it/yct20hubfk061.png?auto=webp&s=32226b397578b664ed794b64938ce40adf3298fe';

        // Initialize player variable
        let player;

        // Create the player once the image is loaded
        playerImage.onload = () => {
            player = new Konva.Image({
                x: stage.width() / 2,
                y: stage.height() - 50,
                image: playerImage,
                width: 60,  // Adjust width if necessary
                height: 60  // Adjust height if necessary
            });
            layer.add(player);
            layer.batchDraw();
        };

        // Initialize level and score
        let level = 1;
        let score = 0;
        let playerBulletDamage = 2; // Initial bullet damage

        // Function to create a boss with a different color and shooting pattern
        let bossHp;
        let boss;
        let bossHpBar;

        function spawnNewBoss() {
            const bossColors = ['red', 'green', 'orange', 'purple', 'cyan'];
            const randomColor = bossColors[Math.floor(Math.random() * bossColors.length)];

            boss = new Konva.Rect({
                x: stage.width() / 2 - 50,
                y: 50,
                width: 100,
                height: 100,
                fill: randomColor
            });
            layer.add(boss);

            bossHp = 100 + (level - 1) * 20; // Increase boss HP with each level
            bossHpBar = new Konva.Rect({
                x: boss.x(),
                y: boss.y() - 20, // Position above the boss
                width: bossHp, // Boss HP starts at 100 + 20 for each level
                height: 10,
                fill: 'green'
            });
            layer.add(bossHpBar);

            layer.batchDraw();
        }

        // Spawn the first boss
        spawnNewBoss();

        // Level text
        const levelText = new Konva.Text({
            x: stage.width() / 2 - 50,
            y: 10,
            text: `Level ${level}`,
            fontSize: 24,
            fill: 'black' // Set text to black
        });
        layer.add(levelText);

        // Player HP Bar (below the player)
        let playerHp = 100;
        const playerHpBar = new Konva.Rect({
            x: player ? player.x() - 30 : 0, // Use player position when available
            y: player ? player.y() + 40 : 0, // Use player position when available
            width: playerHp, // Player HP starts at 100
            height: 10,
            fill: 'green'
        });
        layer.add(playerHpBar);

        // Game over flag
        let isGameOver = false;

        // Function to update Boss HP Bar
        function updateBossHp(damage) {
            if (isGameOver) return; // Stop if game is over
            bossHp = Math.max(0, bossHp - damage); // Reduce boss HP
            bossHpBar.width(bossHp); // Update HP bar width
            if (bossHp === 0) {
                console.log('Boss defeated!');
                score += level * 10; // Calculate score based on level
                boss.destroy(); // Remove the old boss
                bossHpBar.destroy(); // Remove the old boss HP bar
                level++; // Increase the level
                levelText.text(`Level ${level}`); // Update the level text

                // Heal the player when the level changes
                playerHp = Math.min(100, playerHp + 50); // Heal player by 50 (max HP = 100)
                playerHpBar.width(playerHp); // Update the HP bar

                spawnNewBoss(); // Spawn a new boss
                clearInterval(bossShootingInterval); // Clear old shooting interval
                setBossShootingPattern(); // Set the shooting pattern for the new level
            }
            layer.batchDraw();
        }

        // Function to update Player HP Bar
        function updatePlayerHp(damage) {
            if (isGameOver) return; // Stop if game is over
            playerHp = Math.max(0, playerHp - damage); // Reduce player HP
            playerHpBar.width(playerHp); // Update HP bar width
            if (playerHp === 0) {
                console.log('Player defeated! Game Over! Your score: ' + score);
                // Display game over message
                const gameOverOverlay = new Konva.Rect({
                    x: 0,
                    y: 0,
                    width: stage.width(),
                    height: stage.height(),
                    fill: 'black',
                    opacity: 0.8
                });
                layer.add(gameOverOverlay);

                const highestLevelText = new Konva.Text({
                    x: stage.width() / 2 - 150,
                    y: stage.height() / 2 - 50,
                    text: 'Game Over! Your highest level: ' + level,
                    fontSize: 36,
                    fill: 'white' // Set text color to white for visibility on black background
                });
                layer.add(highestLevelText);

                layer.batchDraw();
                clearInterval(bossShootingInterval); // Stop boss shooting
                isGameOver = true; // Set game over flag to true
            }
            layer.batchDraw();
        }

        // Bullet shooting function (Player)
        function shootBullet() {
            if (isGameOver) return; // Stop if game is over
            const bullet = new Konva.Circle({
                x: player.x(),
                y: player.y() - 30,
                radius: 5,
                fill: 'lime' // Changed to a brighter color
            });
            layer.add(bullet);
            bullet.hasDamagedBoss = false; // Add a property to track collision

            // Bullet movement animation
            const anim = new Konva.Animation(() => {
                bullet.y(bullet.y() - 10);

                // Check for collision with the boss
                if (!bullet.hasDamagedBoss && bullet.y() <= boss.y() + boss.height() &&
                    bullet.y() >= boss.y() &&
                    bullet.x() >= boss.x() - 10 && // Adjusted hitbox for collision
                    bullet.x() <= boss.x() + boss.width() + 10) { // Adjusted hitbox for collision
                    updateBossHp(playerBulletDamage); // Deal damage based on playerBulletDamage
                    bullet.hasDamagedBoss = true; // Set the flag to true to avoid further damage
                    bullet.destroy(); // Destroy the bullet upon collision
                }

                if (bullet.y() < 0) {
                    bullet.destroy(); // Remove bullet if it leaves the screen
                }
            }, layer);
            anim.start();
        }

        // Smoother arrow key movement with disabling default behavior
        const keysPressed = {};

        window.addEventListener('keydown', (e) => {
            keysPressed[e.key] = true;

            // Prevent the default scrolling behavior for arrow keys and space
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                e.preventDefault();
            }

            // Event listener for space bar to shoot bullets
            if (e.key === ' ' && !isGameOver) {
                shootBullet();
            }
        });

        window.addEventListener('keyup', (e) => {
            keysPressed[e.key] = false;
        });

        function movePlayer() {
            if (isGameOver) return; // Stop if game is over
            if (keysPressed['ArrowLeft']) {
                player.x(player.x() - 5); // Move left
                playerHpBar.x(player.x() - 30); // Keep HP bar aligned with player
            }
            if (keysPressed['ArrowRight']) {
                player.x(player.x() + 5); // Move right
                playerHpBar.x(player.x() - 30); // Keep HP bar aligned with player
            }
            if (keysPressed['ArrowUp']) {
                player.y(player.y() - 5); // Move up
                playerHpBar.y(player.y() + 40); // Keep HP bar aligned with player
            }
            if (keysPressed['ArrowDown']) {
                player.y(player.y() + 5); // Move down
                playerHpBar.y(player.y() + 40); // Keep HP bar aligned with player
            }

            // Boundaries to prevent the player from going off-screen
            if (player.x() < 0) player.x(0); // Prevent going off screen (left)
            if (player.x() > stage.width()) player.x(stage.width()); // Prevent going off screen (right)
            if (player.y() < 0) player.y(0); // Prevent going off screen (top)
            if (player.y() > stage.height()) player.y(stage.height()); // Prevent going off screen (bottom)

            layer.batchDraw();
        }

        // Boss shooting function
        let bossShootingInterval;

        function setBossShootingPattern() {
            // Function for the boss to shoot bullets towards the player
            bossShootingInterval = setInterval(() => {
                if (isGameOver) return; // Stop if game is over
                const bossBullet = new Konva.Circle({
                    x: boss.x() + boss.width() / 2,
                    y: boss.y() + boss.height(),
                    radius: 5,
                    fill: 'red' // Changed to red for boss bullets
                });
                layer.add(bossBullet);
                bossBullet.hasDamagedPlayer = false; // Track if this bullet has damaged the player

                // Boss bullet movement animation
                const anim = new Konva.Animation(() => {
                    bossBullet.y(bossBullet.y() + 5); // Move down

                    // Check for collision with the player
                    if (!bossBullet.hasDamagedPlayer && 
                        bossBullet.y() >= player.y() - 30 &&
                        bossBullet.y() <= player.y() + 30 &&
                        bossBullet.x() >= player.x() - 30 && // Adjusted hitbox for collision
                        bossBullet.x() <= player.x() + 30) { // Adjusted hitbox for collision
                        updatePlayerHp(10); // Deal damage to the player
                        bossBullet.hasDamagedPlayer = true; // Set the flag to true to avoid further damage
                        bossBullet.destroy(); // Destroy the bullet upon collision
                    }

                    if (bossBullet.y() > stage.height()) {
                        bossBullet.destroy(); // Remove bullet if it leaves the screen
                    }
                }, layer);
                anim.start();
            }, 1000); // Shoot every second
        }

        // Start boss shooting pattern
        setBossShootingPattern();

        // Animation loop
        function animate() {
            movePlayer();
            layer.batchDraw(); // Ensure the layer is redrawn every frame
            requestAnimationFrame(animate);
        }

        animate(); // Start the animation loop
    </script>
</body>
</html>
