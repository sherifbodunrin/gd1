<script src="https://cdn.jsdelivr.net/npm/konva@8.3.0/konva.min.js"></script>
<div id="container"></div>
<script>
  const stage = new Konva.Stage({
    container: 'container',
    width: window.innerWidth,
    height: window.innerHeight
  });
  const layer = new Konva.Layer();
  stage.add(layer);

  // Player represented as a blue circle
  const player = new Konva.Circle({
    x: stage.width() / 2,
    y: stage.height() - 50,
    radius: 30,
    fill: 'blue'
  });
  layer.add(player);

  // Initialize level and score
  let level = 1;
  let score = 0;

  // Initialize power-up variables
  let damagePowerUpActive = false;
  let healthPowerUpActive = false;
  let damagePowerUpTimer;
  let healthPowerUpTimer;

  // Function to create a boss with a different color and shooting pattern
  let bossHp;
  let boss;
  let bossHpBar;

  function spawnNewBoss() {
    const bossColors = ['red', 'green', 'orange', 'purple', 'cyan'];
    const randomColor = bossColors[Math.floor(Math.random() * bossColors.length)];

    boss = new Konva.Rect({
      x: stage.width() / 2 - 50,
      y: 50,
      width: 100,
      height: 100,
      fill: randomColor
    });
    layer.add(boss);

    bossHp = 100;
    bossHpBar = new Konva.Rect({
      x: boss.x(),
      y: boss.y() - 20, // Position above the boss
      width: bossHp, // Boss HP starts at 100
      height: 10,
      fill: 'green'
    });
    layer.add(bossHpBar);

    layer.batchDraw();
  }

  // Spawn the first boss
  spawnNewBoss();

  // Level text
  const levelText = new Konva.Text({
    x: stage.width() / 2 - 50,
    y: 10,
    text: `Level ${level}`,
    fontSize: 24,
    fill: 'black' // Set text to black
  });
  layer.add(levelText);

  // Player HP Bar (below the player)
  let playerHp = 100;
  const playerHpBar = new Konva.Rect({
    x: player.x() - 30,
    y: player.y() + 40, // Position below the player
    width: playerHp, // Player HP starts at 100
    height: 10,
    fill: 'green'
  });
  layer.add(playerHpBar);

  // Function to update Boss HP Bar
  function updateBossHp(damage) {
    bossHp = Math.max(0, bossHp - damage); // Reduce boss HP
    bossHpBar.width(bossHp); // Update HP bar width
    if (bossHp === 0) {
      console.log('Boss defeated!');
      score += level * 10; // Calculate score based on level
      boss.destroy(); // Remove the old boss
      bossHpBar.destroy(); // Remove the old boss HP bar
      level++; // Increase the level
      levelText.text(`Level ${level}`); // Update the level text
      spawnNewBoss(); // Spawn a new boss
      if (level % 3 === 0) { // Spawn power-ups every 3 levels
        spawnPowerUps();
      }
    }
    layer.batchDraw();
  }

  // Function to update Player HP Bar
  function updatePlayerHp(damage) {
    playerHp = Math.max(0, playerHp - damage); // Reduce player HP
    playerHpBar.width(playerHp); // Update HP bar width
    if (playerHp === 0) {
      console.log('Player defeated! Game Over! Your score: ' + score);
      // Display game over message
      const gameOverOverlay = new Konva.Rect({
        x: 0,
        y: 0,
        width: stage.width(),
        height: stage.height(),
        fill: 'black',
        opacity: 0.8
      });
      layer.add(gameOverOverlay);

      const highestLevelText = new Konva.Text({
        x: stage.width() / 2 - 150,
        y: stage.height() / 2 - 50,
        text: 'Game Over! Your highest level: ' + level,
        fontSize: 36,
        fill: 'white' // Set text color to white for visibility on black background
      });
      layer.add(highestLevelText);

      layer.batchDraw();
      clearInterval(bossShootingInterval); // Stop boss shooting
    }
    layer.batchDraw();
  }

  // Function to spawn power-ups
  function spawnPowerUps() {
    const powerUpColors = ['gold', 'pink'];
    const powerUpType = Math.random() < 0.5 ? 'damage' : 'health'; // Randomly choose type
    const randomColor = powerUpColors[Math.floor(Math.random() * powerUpColors.length)];

    const powerUp = new Konva.Circle({
      x: Math.random() * stage.width(),
      y: Math.random() * (stage.height() - 100) + 100, // Spawn above the boss
      radius: 15,
      fill: randomColor,
      powerUpType // Store type in the power-up
    });
    layer.add(powerUp);

    // Power-up collection logic
    powerUp.on('mouseover', () => {
      if (powerUp.powerUpType === 'damage' && !damagePowerUpActive) {
        damagePowerUpActive = true; // Activate damage power-up
        console.log('Damage power-up activated!');
        damagePowerUpTimer = setTimeout(() => {
          damagePowerUpActive = false; // Deactivate after 10 seconds
          console.log('Damage power-up expired!');
        }, 10000); // 10 seconds duration
      } else if (powerUp.powerUpType === 'health' && playerHp < 100) {
        const healthRestore = 30; // Restore 30 HP
        playerHp = Math.min(100, playerHp + healthRestore); // Cap HP at 100
        playerHpBar.width(playerHp); // Update HP bar width
        console.log('Health power-up collected! HP restored by ' + healthRestore);
      }
      powerUp.destroy(); // Remove the power-up after collection
      layer.batchDraw(); // Redraw the layer
    });
  }

  // Bullet shooting function (Player)
  function shootBullet() {
    const bullet = new Konva.Circle({
      x: player.x(),
      y: player.y() - 30,
      radius: 5,
      fill: 'lime' // Changed to a brighter color
    });
    layer.add(bullet);
    bullet.hasDamagedBoss = false; // Add a property to track collision

    // Bullet movement animation
    const anim = new Konva.Animation(() => {
      bullet.y(bullet.y() - 10);

      // Check for collision with the boss
      if (!bullet.hasDamagedBoss && bullet.y() <= boss.y() + boss.height() &&
          bullet.y() >= boss.y() &&
          bullet.x() >= boss.x() + 10 && // Adjusted hitbox for collision
          bullet.x() <= boss.x() + boss.width() - 10) { // Adjusted hitbox for collision
        const damage = damagePowerUpActive ? 4 : 2; // Double damage if power-up active
        updateBossHp(damage); // Deal damage to the boss
        bullet.hasDamagedBoss = true; // Set the flag to true to avoid further damage
        bullet.destroy(); // Destroy the bullet upon collision
      }

      if (bullet.y() < 0) {
        bullet.destroy(); // Remove bullet if it leaves the screen
      }
    }, layer);
    anim.start();
  }

  // Smoother arrow key movement with disabling default behavior
  const keysPressed = {};

  window.addEventListener('keydown', (e) => {
    keysPressed[e.key] = true;

    // Prevent the default scrolling behavior for arrow keys and space
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
      e.preventDefault();
    }

    // Event listener for space bar to shoot bullets
    if (e.key === ' ') {
      shootBullet();
    }
  });

  window.addEventListener('keyup', (e) => {
    keysPressed[e.key] = false;
  });

  function movePlayer() {
    if (keysPressed['ArrowLeft']) {
      player.x(player.x() - 5); // Move left
      playerHpBar.x(player.x() - 30); // Keep HP bar aligned with player
    }
    if (keysPressed['ArrowRight']) {
      player.x(player.x() + 5); // Move right
      playerHpBar.x(player.x() - 30); // Keep HP bar aligned with player
    }
    if (keysPressed['ArrowUp']) {
      player.y(player.y() - 5); // Move up
      playerHpBar.y(player.y() + 40); // Keep HP bar aligned with player
    }
    if (keysPressed['ArrowDown']) {
      player.y(player.y() + 5); // Move down
      playerHpBar.y(player.y() + 40); // Keep HP bar aligned with player
    }
  }

  // Boss shooting logic
  let bossShootingInterval;

  function startBossShooting() {
    bossShootingInterval = setInterval(() => {
      const bullet = new Konva.Circle({
        x: boss.x() + 50, // Shoot from the center of the boss
        y: boss.y() + boss.height(), // Start from the bottom of the boss
        radius: 5,
        fill: 'red'
      });
      layer.add(bullet);

      // Bullet movement animation for boss
      const bossBulletAnim = new Konva.Animation(() => {
        bullet.y(bullet.y() + 10); // Move bullet downwards

        // Check for collision with the player
        if (bullet.y() > player.y() - 30 && bullet.y() < player.y() + 30 &&
            bullet.x() > player.x() - 30 && bullet.x() < player.x() + 30) {
          const damage = damagePowerUpActive ? 4 : 2; // Double damage if power-up active
          updatePlayerHp(damage); // Deal damage to the player
          bullet.destroy(); // Destroy the bullet upon collision
        }

        if (bullet.y() > stage.height()) {
          bullet.destroy(); // Remove bullet if it leaves the screen
        }
      }, layer);
      bossBulletAnim.start();
    }, 1000); // Boss shoots every second
  }

  startBossShooting(); // Start boss shooting

  // Game loop
  const gameLoop = new Konva.Animation(() => {
    movePlayer();
  }, layer);
  gameLoop.start();

  // Pause and restart buttons
  const pauseButton = document.createElement('button');
  pauseButton.innerText = 'Pause';
  pauseButton.style.position = 'absolute';
  pauseButton.style.top = '10px';
  pauseButton.style.right = '100px'; // Adjust position
  document.body.appendChild(pauseButton);

  const restartButton = document.createElement('button');
  restartButton.innerText = 'Restart';
  restartButton.style.position = 'absolute';
  restartButton.style.top = '10px';
  restartButton.style.right = '10px'; // Adjust position
  document.body.appendChild(restartButton);

  let gamePaused = false;

  pauseButton.addEventListener('click', () => {
    gamePaused = !gamePaused; // Toggle pause state
    pauseButton.innerText = gamePaused ? 'Resume' : 'Pause'; // Change button text
    if (gamePaused) {
      gameLoop.stop(); // Stop the game loop
      clearInterval(bossShootingInterval); // Stop boss shooting
    } else {
      gameLoop.start(); // Restart the game loop
      startBossShooting(); // Restart boss shooting
    }
  });

  restartButton.addEventListener('click', () => {
    // Reset game state
    player.x(stage.width() / 2);
    player.y(stage.height() - 50);
    playerHp = 100;
    playerHpBar.width(playerHp);
    level = 1;
    score = 0;
    damagePowerUpActive = false;
    healthPowerUpActive = false;

    // Reset level text
    levelText.text(`Level ${level}`);
    
    // Remove existing boss and HP bar
    if (boss) {
      boss.destroy();
    }
    if (bossHpBar) {
      bossHpBar.destroy();
    }

    // Spawn the first boss again
    spawnNewBoss();

    // Clear and restart shooting intervals and animations
    clearInterval(bossShootingInterval);
    startBossShooting();

    // Clear game over overlays if present
    layer.find((node) => node.getClassName() === 'Rect' && node.fill() === 'black').destroy();
    layer.find((node) => node.getClassName() === 'Text' && node.text().includes('Game Over')).destroy();

    layer.batchDraw(); // Redraw the layer
  });

  // Resize handling
  window.addEventListener('resize', () => {
    stage.width(window.innerWidth);
    stage.height(window.innerHeight);
  });
</script>
