<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game</title>
    <script src="https://cdn.jsdelivr.net/npm/konva@8.0.0/konva.min.js"></script>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>

<div id="container"></div>

<script>
    const stage = new Konva.Stage({
        container: 'container',
        width: 800,
        height: 600
    });

    const layer = new Konva.Layer();
    stage.add(layer);

    let gameOver = false; // Flag to track game state

    // Create a player rectangle
    const player = new Konva.Rect({
        x: stage.width() / 2 - 25,
        y: stage.height() - 60,
        width: 50,
        height: 50,
        fill: 'blue'
    });
    layer.add(player);

    // Create a boss rectangle
    const boss = new Konva.Rect({
        x: stage.width() / 2 - 75,
        y: 50,
        width: 150,
        height: 50,
        fill: 'red'
    });
    layer.add(boss);

    // Player HP
    let playerHp = 100;
    const playerHpBar = new Konva.Rect({
        x: player.x() - 30,
        y: player.y() + 40,
        width: playerHp,
        height: 10,
        fill: 'green'
    });
    layer.add(playerHpBar);

    // Boss HP
    let bossHp = 300;
    const bossHpBar = new Konva.Rect({
        x: boss.x(),
        y: boss.y() - 20,
        width: bossHp,
        height: 10,
        fill: 'green'
    });
    layer.add(bossHpBar);

    let keysPressed = {};

    // Update player HP and handle game over
    function updatePlayerHp(damage) {
        if (gameOver) return; // Prevent updating HP if the game is over
        playerHp = Math.max(0, playerHp - damage);
        playerHpBar.width(playerHp);
        if (playerHp === 0) {
            gameOver = true; // Set game over
            console.log('Player defeated! Game Over!');

            const gameOverOverlay = new Konva.Rect({
                x: 0,
                y: 0,
                width: stage.width(),
                height: stage.height(),
                fill: 'black',
                opacity: 0.8
            });
            layer.add(gameOverOverlay);

            const gameOverText = new Konva.Text({
                x: stage.width() / 2 - 150,
                y: stage.height() / 2 - 50,
                text: 'Game Over!',
                fontSize: 36,
                fill: 'white' // Set text color to white for visibility on black background
            });
            layer.add(gameOverText);

            layer.batchDraw();
            clearInterval(bossShootingInterval); // Stop boss shooting
        }
        layer.batchDraw();
    }

    // Update boss HP
    function updateBossHp(damage) {
        if (gameOver) return; // Prevent if the game is over
        bossHp = Math.max(0, bossHp - damage);
        bossHpBar.width(bossHp);
        if (bossHp === 0) {
            console.log('Boss defeated!');
        }
        layer.batchDraw();
    }

    // Handle shooting
    function shootBullet() {
        if (gameOver) return; // Prevent shooting if the game is over
        const bullet = new Konva.Circle({
            x: player.x(),
            y: player.y() - 30,
            radius: 5,
            fill: 'lime'
        });
        layer.add(bullet);
        bullet.hasDamagedBoss = false;

        const anim = new Konva.Animation(() => {
            bullet.y(bullet.y() - 10);

            if (!bullet.hasDamagedBoss && bullet.y() <= boss.y() + boss.height() &&
                bullet.y() >= boss.y() &&
                bullet.x() >= boss.x() - 10 &&
                bullet.x() <= boss.x() + boss.width() + 10) {
                updateBossHp(10); // Example bullet damage value
                bullet.hasDamagedBoss = true;
                bullet.destroy();
            }

            if (bullet.y() < 0) {
                bullet.destroy();
            }
        }, layer);
        anim.start();
    }

    // Arrow key movement with prevention of default scrolling
    window.addEventListener('keydown', (e) => {
        if (gameOver) return; // Prevent actions if game is over
        keysPressed[e.key] = true;

        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
            e.preventDefault();
        }

        // Shoot bullets with space bar
        if (e.key === ' ') {
            shootBullet();
        }
    });

    window.addEventListener('keyup', (e) => {
        keysPressed[e.key] = false;
    });

    function movePlayer() {
        if (gameOver) return; // Prevent movement if game is over
        if (keysPressed['ArrowLeft']) {
            player.x(player.x() - 5);
            playerHpBar.x(player.x() - 30);
        }
        if (keysPressed['ArrowRight']) {
            player.x(player.x() + 5);
            playerHpBar.x(player.x() - 30);
        }
        if (keysPressed['ArrowUp']) {
            player.y(player.y() - 5);
            playerHpBar.y(player.y() + 40);
        }
        if (keysPressed['ArrowDown']) {
            player.y(player.y() + 5);
            playerHpBar.y(player.y() + 40);
        }

        if (player.x() < 0) player.x(0);
        if (player.x() > stage.width()) player.x(stage.width());
        if (player.y() < 0) player.y(0);
        if (player.y() > stage.height()) player.y(stage.height());

        layer.batchDraw();
    }

    // Move player at a regular interval
    setInterval(movePlayer, 16);

    // Boss shooting interval
    const bossShootingInterval = setInterval(() => {
        if (gameOver) return; // Prevent boss shooting if game is over
        const bossBullet = new Konva.Circle({
            x: boss.x() + boss.width() / 2,
            y: boss.y() + boss.height(),
            radius: 5,
            fill: 'orange'
        });
        layer.add(bossBullet);

        const anim = new Konva.Animation(() => {
            bossBullet.y(bossBullet.y() + 5);

            // Check for collision with player
            if (bossBullet.y() >= player.y() &&
                bossBullet.x() >= player.x() &&
                bossBullet.x() <= player.x() + player.width()) {
                updatePlayerHp(20); // Example boss bullet damage value
                bossBullet.destroy();
            }

            if (bossBullet.y() > stage.height()) {
                bossBullet.destroy();
            }
        }, layer);
        anim.start();
    }, 1000);

    layer.batchDraw();
</script>

</body>
</html>
