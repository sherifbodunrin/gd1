<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boss Battle Game</title>
    <script src="https://cdn.jsdelivr.net/npm/konva@8.3.0/konva.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <script>
        const stage = new Konva.Stage({
            container: 'container',
            width: window.innerWidth,
            height: window.innerHeight
        });
        const layer = new Konva.Layer();
        stage.add(layer);

        // Add background image
        const backgroundImageObj = new Image();
        backgroundImageObj.src = 'https://opengameart.org/sites/default/files/bg_02_h.png'; // Background image URL
        
       backgroundImageObj.onload = function() {
        const background = new Konva.Image({
        x: 0,
        y: 0,
        image: backgroundImageObj,
        width: stage.width(),
        height: stage.height()
        });
        layer.add(background); // Add background to the layer first
        layer.batchDraw();

        // Now add other images after the background is added
        initializeGameObjects(); // Call a function to initialize player and boss
        };

        // Player represented as a blue circle
        function initializeGameObjects()
        const playerImageObj = new Image();
        playerImageObj.src = 'https://i.pinimg.com/originals/cf/04/e4/cf04e4e031c7bbd277a74cf32a3a6362.png';
        
        const player = new Konva.Image({
            x: stage.width() / 2 - 30,
            y: stage.height() - 80,
            image: playerImageObj,
            width: 60,
            height: 60
        });
        layer.add(player);
        spawnNewBoss()
        }
        
        // Initialize level and score
        let level = 1;
        let score = 0;
        let playerBulletDamage = 2;

        let bossHp;
        let boss;
        let bossHpBar;

        // Load the boss image
        const bossImageObj = new Image();
        bossImageObj.src = 'https://cdna.artstation.com/p/assets/images/images/006/503/674/original/william-robinson-gun-alien-firing-animation.gif?1499108623'; // Replace with your boss image URL
        
        function spawnNewBoss() {
            boss = new Konva.Image({
                x: stage.width() / 2 - 50,
                y: 50,
                image: bossImageObj,
                width: 100,
                height: 100
            });
            layer.add(boss);

            bossHp = 100 + (level - 1) * 20;
            bossHpBar = new Konva.Rect({
                x: boss.x(),
                y: boss.y() - 20,
                width: bossHp,
                height: 10,
                fill: 'green'
            });
            layer.add(bossHpBar);

            layer.batchDraw();
        }

    

        const levelText = new Konva.Text({
            x: stage.width() / 2 - 50,
            y: 10,
            text: `Level ${level}`,
            fontSize: 24,
            fill: 'black'
        });
        layer.add(levelText);

        let playerHp = 100;
        const playerHpBar = new Konva.Rect({
            x: player.x() - 30,
            y: player.y() + 40,
            width: playerHp,
            height: 10,
            fill: 'green'
        });
        layer.add(playerHpBar);

        let isGameOver = false;

        function updateBossHp(damage) {
            if (isGameOver) return;
            bossHp = Math.max(0, bossHp - damage);
            bossHpBar.width(bossHp);
            if (bossHp === 0) {
                score += level * 10;
                boss.destroy();
                bossHpBar.destroy();
                level++;
                levelText.text(`Level ${level}`);

                playerHp = Math.min(100, playerHp + 50);
                playerHpBar.width(playerHp);

                spawnNewBoss();
                clearInterval(bossShootingInterval);
                setRandomBossShootingPattern();
            }
            layer.batchDraw();
        }

        function updatePlayerHp(damage) {
            if (isGameOver) return;
            playerHp = Math.max(0, playerHp - damage);
            playerHpBar.width(playerHp);
            if (playerHp === 0) {
                const gameOverOverlay = new Konva.Rect({
                    x: 0,
                    y: 0,
                    width: stage.width(),
                    height: stage.height(),
                    fill: 'black',
                    opacity: 0.8
                });
                layer.add(gameOverOverlay);

                const highestLevelText = new Konva.Text({
                    x: stage.width() / 2 - 150,
                    y: stage.height() / 2 - 50,
                    text: 'Game Over! Your highest level: ' + level,
                    fontSize: 36,
                    fill: 'white'
                });
                layer.add(highestLevelText);

                layer.batchDraw();
                clearInterval(bossShootingInterval);
                isGameOver = true;
            }
            layer.batchDraw();
        }

        function shootBullet() {
            if (isGameOver) return;
            const bullet = new Konva.Circle({
                x: player.x(),
                y: player.y() - 30,
                radius: 5,
                fill: 'lime'
            });
            layer.add(bullet);
            bullet.hasDamagedBoss = false;

            const anim = new Konva.Animation(() => {
                bullet.y(bullet.y() - 10);

                if (!bullet.hasDamagedBoss && bullet.y() <= boss.y() + boss.height() &&
                    bullet.y() >= boss.y() &&
                    bullet.x() >= boss.x() - 10 &&
                    bullet.x() <= boss.x() + boss.width() + 10) {
                    updateBossHp(playerBulletDamage);
                    bullet.hasDamagedBoss = true;
                    bullet.destroy();
                }

                if (bullet.y() < 0) {
                    bullet.destroy();
                }
            }, layer);
            anim.start();
        }

        const keysPressed = {};

        window.addEventListener('keydown', (e) => {
            keysPressed[e.key] = true;

            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                e.preventDefault();
            }

            if (e.key === ' ' && !isGameOver) {
                shootBullet();
            }
        });

        window.addEventListener('keyup', (e) => {
            keysPressed[e.key] = false;
        });

        function movePlayer() {
            if (isGameOver) return;
            if (keysPressed['ArrowLeft']) {
                player.x(player.x() - 5);
                playerHpBar.x(player.x() - 30);
            }
            if (keysPressed['ArrowRight']) {
                player.x(player.x() + 5);
                playerHpBar.x(player.x() - 30);
            }
            if (keysPressed['ArrowUp']) {
                player.y(player.y() - 5);
                playerHpBar.y(player.y() + 40);
            }
            if (keysPressed['ArrowDown']) {
                player.y(player.y() + 5);
                playerHpBar.y(player.y() + 40);
            }

            if (player.x() < 0) player.x(0);
            if (player.x() > stage.width()) player.x(stage.width());
            if (player.y() < 0) player.y(0);
            if (player.y() > stage.height()) player.y(stage.height());

            layer.batchDraw();
        }

        let bossShootingInterval;

        function setRandomBossShootingPattern() {
            const patterns = [randomSpread, radialBurst, targetedShot];
            const randomPattern = patterns[Math.floor(Math.random() * patterns.length)];
            randomPattern();
        }

        function randomSpread() {
            bossShootingInterval = setInterval(() => {
                if (isGameOver) return;

                const angle = Math.random() * Math.PI * 2;
                const velocityX = Math.cos(angle) * 7; // Increased speed
                const velocityY = Math.sin(angle) * 7; // Increased speed

                const bossBullet = new Konva.Circle({
                    x: boss.x() + boss.width() / 2,
                    y: boss.y() + boss.height() / 2,
                    radius: 5,
                    fill: 'red'
                });
                layer.add(bossBullet);
                bossBullet.hasDamagedPlayer = false;

                const anim = new Konva.Animation(() => {
                    bossBullet.x(bossBullet.x() + velocityX);
                    bossBullet.y(bossBullet.y() + velocityY);

                    if (!bossBullet.hasDamagedPlayer &&
                        bossBullet.y() >= player.y() - 30 &&
                        bossBullet.y() <= player.y() + 30 &&
                        bossBullet.x() >= player.x() - 30 &&
                        bossBullet.x() <= player.x() + 30) {
                        updatePlayerHp(15); // Increased damage
                        bossBullet.hasDamagedPlayer = true;
                        bossBullet.destroy();
                    }

                    if (bossBullet.y() > stage.height() || bossBullet.y() < 0 ||
                        bossBullet.x() > stage.width() || bossBullet.x() < 0) {
                        bossBullet.destroy();
                    }
                }, layer);
                anim.start();
            }, 1000); // Reduced interval to make the pattern faster
        }

        function radialBurst() {
            bossShootingInterval = setInterval(() => {
                if (isGameOver) return;

                const numBullets = 12;
                for (let i = 0; i < numBullets; i++) {
                    const angle = (Math.PI * 2 / numBullets) * i;
                    const velocityX = Math.cos(angle) * 5; // Increased speed
                    const velocityY = Math.sin(angle) * 5; // Increased speed

                    const bossBullet = new Konva.Circle({
                        x: boss.x() + boss.width() / 2,
                        y: boss.y() + boss.height() / 2,
                        radius: 5,
                        fill: 'orange'
                    });
                    layer.add(bossBullet);
                    bossBullet.hasDamagedPlayer = false;

                    const anim = new Konva.Animation(() => {
                        bossBullet.x(bossBullet.x() + velocityX);
                        bossBullet.y(bossBullet.y() + velocityY);

                        if (!bossBullet.hasDamagedPlayer &&
                            bossBullet.y() >= player.y() - 30 &&
                            bossBullet.y() <= player.y() + 30 &&
                            bossBullet.x() >= player.x() - 30 &&
                            bossBullet.x() <= player.x() + 30) {
                            updatePlayerHp(10);
                            bossBullet.hasDamagedPlayer = true;
                            bossBullet.destroy();
                        }

                        if (bossBullet.y() > stage.height() || bossBullet.y() < 0 ||
                            bossBullet.x() > stage.width() || bossBullet.x() < 0) {
                            bossBullet.destroy();
                        }
                    }, layer);
                    anim.start();
                }
            }, 2000);
        }

        function targetedShot() {
            bossShootingInterval = setInterval(() => {
                if (isGameOver) return;

                const angle = Math.atan2(player.y() - boss.y(), player.x() - boss.x());
                const velocityX = Math.cos(angle) * 6; // Increased speed
                const velocityY = Math.sin(angle) * 6; // Increased speed

                const bossBullet = new Konva.Circle({
                    x: boss.x() + boss.width() / 2,
                    y: boss.y() + boss.height() / 2,
                    radius: 5,
                    fill: 'purple'
                });
                layer.add(bossBullet);
                bossBullet.hasDamagedPlayer = false;

                const anim = new Konva.Animation(() => {
                    bossBullet.x(bossBullet.x() + velocityX);
                    bossBullet.y(bossBullet.y() + velocityY);

                    if (!bossBullet.hasDamagedPlayer &&
                        bossBullet.y() >= player.y() - 30 &&
                        bossBullet.y() <= player.y() + 30 &&
                        bossBullet.x() >= player.x() - 30 &&
                        bossBullet.x() <= player.x() + 30) {
                        updatePlayerHp(20); // Increased damage
                        bossBullet.hasDamagedPlayer = true;
                        bossBullet.destroy();
                    }

                    if (bossBullet.y() > stage.height() || bossBullet.y() < 0 ||
                        bossBullet.x() > stage.width() || bossBullet.x() < 0) {
                        bossBullet.destroy();
                    }
                }, layer);
                anim.start();
            }, 1500);
        }

        setRandomBossShootingPattern();

        const anim = new Konva.Animation(() => {
            movePlayer();
        }, layer);
        anim.start();
    </script>
</body>
</html>
