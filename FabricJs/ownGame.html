<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boss Battle Game</title>
    <script src="https://cdn.jsdelivr.net/npm/konva@8.3.0/konva.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <script>
        const stage = new Konva.Stage({
            container: 'container',
            width: window.innerWidth,
            height: window.innerHeight
        });
        const layer = new Konva.Layer();
        stage.add(layer);

        let level = 1;
        let score = 0;
        let isGameOver = false;
        let playerHp = 100;
        let bossHp;
        let boss;
        let bossHpBar;
        let bossShootingInterval;
        let keysPressed = {};

        const playerImageObj = new Image();
        const bossImageObj = new Image();

        playerImageObj.src = 'https://i.pinimg.com/originals/cf/04/e4/cf04e4e031c7bbd277a74cf32a3a6362.png';
        bossImageObj.src = 'https://example.com/path/to/your/boss/image.png'; // Update with correct image URL

        // Load images before starting the game
        playerImageObj.onload = () => {
            bossImageObj.onload = () => {
                startGame();
            };
        };

        function startGame() {
            // Player setup
            const player = new Konva.Image({
                x: stage.width() / 2 - 30,
                y: stage.height() - 80,
                image: playerImageObj,
                width: 60,
                height: 60
            });
            layer.add(player);

            const playerHpBar = new Konva.Rect({
                x: player.x() - 30,
                y: player.y() + 40,
                width: playerHp,
                height: 10,
                fill: 'green'
            });
            layer.add(playerHpBar);

            // Boss setup
            spawnNewBoss();

            // Game loop
            gameLoop();

            // Event listeners for movement and shooting
            window.addEventListener('keydown', (e) => {
                keysPressed[e.key] = true;

                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                    e.preventDefault();
                }

                if (e.key === ' ' && !isGameOver) {
                    shootBullet(player, playerHpBar);
                }
            });

            window.addEventListener('keyup', (e) => {
                keysPressed[e.key] = false;
            });
        }

        function spawnNewBoss() {
            boss = new Konva.Image({
                x: stage.width() / 2 - 50,
                y: 50,
                image: bossImageObj,
                width: 100,
                height: 100
            });
            layer.add(boss);

            bossHp = 100 + (level - 1) * 20;
            bossHpBar = new Konva.Rect({
                x: boss.x(),
                y: boss.y() - 20,
                width: bossHp,
                height: 10,
                fill: 'green'
            });
            layer.add(bossHpBar);

            layer.batchDraw();
            setRandomBossShootingPattern();
        }

        function updateBossHp(damage) {
            if (isGameOver) return;
            bossHp = Math.max(0, bossHp - damage);
            bossHpBar.width(bossHp);
            if (bossHp === 0) {
                level++;
                score += level * 10;
                boss.destroy();
                bossHpBar.destroy();
                spawnNewBoss();
            }
            layer.batchDraw();
        }

        function updatePlayerHp(playerHpBar, damage) {
            if (isGameOver) return;
            playerHp = Math.max(0, playerHp - damage);
            playerHpBar.width(playerHp);
            if (playerHp === 0) {
                gameOver();
            }
            layer.batchDraw();
        }

        function gameOver() {
            isGameOver = true;
            const gameOverOverlay = new Konva.Rect({
                x: 0,
                y: 0,
                width: stage.width(),
                height: stage.height(),
                fill: 'black',
                opacity: 0.8
            });
            layer.add(gameOverOverlay);

            const highestLevelText = new Konva.Text({
                x: stage.width() / 2 - 150,
                y: stage.height() / 2 - 50,
                text: 'Game Over! Your highest level: ' + level,
                fontSize: 36,
                fill: 'white'
            });
            layer.add(highestLevelText);

            layer.batchDraw();
            clearInterval(bossShootingInterval);
        }

        function shootBullet(player, playerHpBar) {
            if (isGameOver) return;
            const bullet = new Konva.Circle({
                x: player.x() + player.width() / 2,
                y: player.y() - 10,
                radius: 5,
                fill: 'lime'
            });
            layer.add(bullet);

            const anim = new Konva.Animation(() => {
                bullet.y(bullet.y() - 10);
                if (bullet.y() <= boss.y() + boss.height() &&
                    bullet.x() >= boss.x() &&
                    bullet.x() <= boss.x() + boss.width()) {
                    updateBossHp(10); // Deal damage to boss
                    bullet.destroy();
                }
                if (bullet.y() < 0) {
                    bullet.destroy();
                }
            }, layer);
            anim.start();
        }

        function movePlayer(player, playerHpBar) {
            if (isGameOver) return;

            if (keysPressed['ArrowLeft']) {
                player.x(player.x() - 5);
                playerHpBar.x(player.x() - 30);
            }
            if (keysPressed['ArrowRight']) {
                player.x(player.x() + 5);
                playerHpBar.x(player.x() - 30);
            }
            if (keysPressed['ArrowUp']) {
                player.y(player.y() - 5);
                playerHpBar.y(player.y() + 40);
            }
            if (keysPressed['ArrowDown']) {
                player.y(player.y() + 5);
                playerHpBar.y(player.y() + 40);
            }

            // Ensure player stays within stage boundaries
            if (player.x() < 0) player.x(0);
            if (player.x() > stage.width() - player.width()) player.x(stage.width() - player.width());
            if (player.y() < 0) player.y(0);
            if (player.y() > stage.height() - player.height()) player.y(stage.height() - player.height());

            layer.batchDraw();
        }

        function setRandomBossShootingPattern() {
            const patterns = [randomSpread, radialBurst, targetedShot];
            const randomPattern = patterns[Math.floor(Math.random() * patterns.length)];
            randomPattern();
        }

        function randomSpread() {
            bossShootingInterval = setInterval(() => {
                if (isGameOver) return;
                shootBossBullet(Math.random() * Math.PI * 2, 5);
            }, 1000); // Adjust interval as needed
        }

        function radialBurst() {
            const numBullets = 12;
            bossShootingInterval = setInterval(() => {
                if (isGameOver) return;
                for (let i = 0; i < numBullets; i++) {
                    shootBossBullet((Math.PI * 2 / numBullets) * i, 3);
                }
            }, 1500);
        }

        function targetedShot() {
            bossShootingInterval = setInterval(() => {
                if (isGameOver) return;
                const angle = Math.atan2(player.y() - boss.y(), player.x() - boss.x());
                shootBossBullet(angle, 4);
            }, 1000);
        }

        function shootBossBullet(angle, speed) {
            const bossBullet = new Konva.Circle({
                x: boss.x() + boss.width() / 2,
                y: boss.y() + boss.height() / 2,
                radius: 5,
                fill: 'red'
            });
            layer.add(bossBullet);

            const anim = new Konva.Animation(() => {
                bossBullet.x(bossBullet.x() + Math.cos(angle) * speed);
                bossBullet.y(bossBullet.y() + Math.sin(angle) * speed);
                if (bossBullet.x() < 0 || bossBullet.x() > stage.width() ||
                    bossBullet.y() < 0 || bossBullet.y() > stage.height()) {
                    bossBullet.destroy();
                }
                if (bossBullet.x() >= player.x() &&
                    bossBullet.x() <= player.x() + player.width() &&
                    bossBullet.y() >= player.y() &&
                    bossBullet.y() <= player.y() + player.height()) {
                    updatePlayerHp(playerHpBar, 10); // Deal damage to player
                    bossBullet.destroy();
                }
            }, layer);
            anim.start();
        }

        function gameLoop() {
            const anim = new Konva.Animation(() => {
                if (!isGameOver) {
                    movePlayer(player, playerHpBar);
                }
            }, layer);
            anim.start();
        }

    </script>
</body>
</html>
