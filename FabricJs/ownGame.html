<script src="https://cdn.jsdelivr.net/npm/konva@8.3.0/konva.min.js"></script>
<div id="container"></div>
<script>
  const stage = new Konva.Stage({
    container: 'container',
    width: window.innerWidth,
    height: window.innerHeight
  });
  const layer = new Konva.Layer();
  stage.add(layer);

  // Player represented as a blue circle
  const player = new Konva.Circle({
    x: stage.width() / 2,
    y: stage.height() - 50,
    radius: 30,
    fill: 'blue'
  });
  layer.add(player);

  // Scoreboard
  let score = 0;
  const scoreText = new Konva.Text({
    x: 20,
    y: 20,
    text: `Score: ${score}`,
    fontSize: 24,
    fill: 'white'
  });
  layer.add(scoreText);

  // Enemy creation function
  function createEnemy() {
    const enemy = new Konva.Circle({
      x: Math.random() * stage.width(),
      y: -20,
      radius: 20,
      fill: 'green'
    });
    layer.add(enemy);
    
    const anim = new Konva.Animation(() => {
      enemy.y(enemy.y() + 2); // Enemy falls down
      if (enemy.y() > stage.height()) {
        enemy.destroy(); // Destroy if it goes off-screen
      }
    }, layer);
    anim.start();

    return enemy;
  }

  // Generate enemies every second
  setInterval(() => {
    createEnemy();
  }, 1000);

  // Bullet shooting function
  function shootBullet() {
    const bullet = new Konva.Circle({
      x: player.x(),
      y: player.y() - 30,
      radius: 5,
      fill: 'red'
    });
    layer.add(bullet);

    const anim = new Konva.Animation(() => {
      bullet.y(bullet.y() - 10); // Bullet moves upward
      if (bullet.y() < 0) {
        bullet.destroy(); // Destroy if bullet goes off-screen
      }
    }, layer);
    anim.start();
    return bullet;
  }

  // Check for collision between two circles
  function isColliding(bullet, enemy) {
    const distX = bullet.x() - enemy.x();
    const distY = bullet.y() - enemy.y();
    const distance = Math.sqrt(distX * distX + distY * distY);

    return distance < bullet.radius() + enemy.radius();
  }

  // Smoother movement for the player
  const keysPressed = {};

  window.addEventListener('keydown', (e) => {
    keysPressed[e.key] = true;
  });

  window.addEventListener('keyup', (e) => {
    keysPressed[e.key] = false;
  });

  function movePlayer() {
    if (keysPressed['ArrowLeft']) {
      player.x(player.x() - 5); // Move left
    }
    if (keysPressed['ArrowRight']) {
      player.x(player.x() + 5); // Move right
    }
    if (player.x() < 0) player.x(0);
    if (player.x() > stage.width()) player.x(stage.width());

    layer.batchDraw();
  }

  // Start a continuous loop for smoother movement
  setInterval(movePlayer, 16); // 60 FPS

  // Shooting bullets
  stage.on('click', () => {
    const bullet = shootBullet();

    // Check for collision between bullet and enemies
    const anim = new Konva.Animation(() => {
      layer.getChildren().forEach((enemy) => {
        if (enemy !== player && enemy !== scoreText && isColliding(bullet, enemy)) {
          // If collision, destroy both bullet and enemy
          bullet.destroy();
          enemy.destroy();
          
          // Increase the score
          score++;
          scoreText.text(`Score: ${score}`);
        }
      });
    }, layer);
    anim.start();
  });

  layer.draw();
</script>
